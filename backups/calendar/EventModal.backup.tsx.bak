'use client'

import { CalendarEvent } from '@schedule-x/calendar'
import { Temporal } from '@js-temporal/polyfill'
import { format } from 'date-fns'
import { ko } from 'date-fns/locale'
import { formatDaysUntil } from '@/types/court-hearing'
import { useRouter } from 'next/navigation'

// ========================================
// Helper Functions
// ========================================

function getTimeFromStart(start: string | Temporal.PlainDate | Temporal.ZonedDateTime | unknown): string | null {
  if (typeof start === 'string') {
    const parts = start.split(' ')
    return parts.length > 1 ? parts[1]?.slice(0, 5) : null
  }
  if (start && typeof start === 'object' && 'hour' in start) {
    const zdt = start as Temporal.ZonedDateTime
    const hour = String(zdt.hour).padStart(2, '0')
    const minute = String(zdt.minute).padStart(2, '0')
    if (hour === '00' && minute === '00') return null
    return `${hour}:${minute}`
  }
  return null
}

function getDateFromStart(start: string | Temporal.PlainDate | Temporal.ZonedDateTime | unknown): Date {
  if (typeof start === 'string') {
    const datePart = start.split(' ')[0]
    return new Date(datePart + 'T00:00:00')
  }
  if (start && typeof start === 'object') {
    const obj = start as { year: number; month: number; day: number }
    return new Date(obj.year, obj.month - 1, obj.day)
  }
  return new Date()
}

// Event type labels
const EVENT_TYPE_LABELS: Record<string, string> = {
  COURT_HEARING: '법원기일',
  DEADLINE: '마감일',
  CONSULTATION: '상담',
  MEETING: '회의',
}

const HEARING_TYPE_LABELS: Record<string, string> = {
  HEARING_TRIAL: '변론기일',
  HEARING_PREPARATION: '준비기일',
  HEARING_MEDIATION: '조정기일',
  HEARING_JUDGMENT: '판결선고',
  HEARING_LAWYER_MEETING: '변호사 미팅',
  HEARING_PARENTING: '양육상담',
  HEARING_INVESTIGATION: '가사조사',
  HEARING_OTHER: '기타기일',
}

// Color configurations for event types
const EVENT_TYPE_COLORS: Record<string, { dot: string; bg: string; border: string }> = {
  COURT_HEARING: { dot: 'bg-[var(--sage-primary)]', bg: 'bg-[var(--sage-muted)]', border: 'border-[var(--sage-primary)]' },
  DEADLINE: { dot: 'bg-[#F59E0B]', bg: 'bg-orange-50', border: 'border-[#F59E0B]' },
  CONSULTATION: { dot: 'bg-[var(--color-info)]', bg: 'bg-[var(--color-info-muted)]', border: 'border-[var(--color-info)]' },
  MEETING: { dot: 'bg-gray-500', bg: 'bg-gray-50', border: 'border-gray-500' },
}

// Check if hearing is postponed
const isPostponedHearing = (result?: string): boolean => {
  if (!result) return false
  const keywords = ['기일변경', '연기', '취하', '취소', '변경지정']
  return keywords.some(kw => result.includes(kw))
}

// Get video badge info
const getVideoBadgeInfo = (scourtTypeRaw?: string, videoParticipantSide?: string, ourClientSide?: string): { label: string; color: string } | null => {
  if (scourtTypeRaw?.includes('쌍방 화상장치') || scourtTypeRaw?.includes('쌍방화상장치') || videoParticipantSide === 'both') {
    return { label: '화상', color: 'bg-purple-100 text-purple-700' }
  }
  if (videoParticipantSide && ourClientSide) {
    if (videoParticipantSide === ourClientSide) {
      return { label: '화상', color: 'bg-purple-100 text-purple-700' }
    }
    return null
  }
  if (scourtTypeRaw?.includes('일방 화상장치') || scourtTypeRaw?.includes('일방화상장치')) {
    return { label: '화상?', color: 'bg-gray-100 text-gray-600' }
  }
  return null
}

// ========================================
// EventModal Component
// ========================================

interface EventModalProps {
  calendarEvent: CalendarEvent
}

export default function EventModal({ calendarEvent }: EventModalProps) {
  const router = useRouter()

  // Extract custom properties from calendarEvent
  const eventType = (calendarEvent as any).eventType as string | undefined
  const eventSubtype = (calendarEvent as any).eventSubtype as string | undefined
  const caseNumber = (calendarEvent as any).caseNumber as string | undefined
  const caseName = (calendarEvent as any).caseName as string | undefined
  const caseId = (calendarEvent as any).caseId as string | undefined
  const location = calendarEvent.location
  const description = calendarEvent.description
  const scourtTypeRaw = (calendarEvent as any).scourtTypeRaw as string | undefined
  const scourtResultRaw = (calendarEvent as any).scourtResultRaw as string | undefined
  const videoParticipantSide = (calendarEvent as any).videoParticipantSide as string | undefined
  const ourClientSide = (calendarEvent as any).ourClientSide as string | undefined
  const daysUntil = (calendarEvent as any).daysUntil as number | undefined
  const attendingLawyerName = (calendarEvent as any).attendingLawyerName as string | undefined

  // Computed values
  const isPostponed = isPostponedHearing(scourtResultRaw)
  const videoBadge = getVideoBadgeInfo(scourtTypeRaw, videoParticipantSide, ourClientSide)
  const eventDate = getDateFromStart(calendarEvent.start)
  const timeStr = getTimeFromStart(calendarEvent.start)

  // Get display type label
  const getTypeLabel = (): string => {
    if (eventType === 'COURT_HEARING') {
      if (isPostponed) return '연기'
      if (eventSubtype) {
        // Use raw scourt_type for more accurate display
        if (scourtTypeRaw) {
          const cleanType = scourtTypeRaw
            .replace(/\s*\[(일방|쌍방)\s*화상장치\]\s*/g, '')
            .trim()
          return cleanType || HEARING_TYPE_LABELS[eventSubtype] || '법원기일'
        }
        return HEARING_TYPE_LABELS[eventSubtype] || '법원기일'
      }
      return '법원기일'
    }
    return EVENT_TYPE_LABELS[eventType || ''] || '일정'
  }

  // Get color config
  const colorConfig = EVENT_TYPE_COLORS[eventType || ''] || EVENT_TYPE_COLORS.MEETING

  // Navigate to case page
  const handleCaseClick = () => {
    if (caseId) {
      router.push(`/cases/${caseId}`)
    }
  }

  // Format date string
  const formattedDate = format(eventDate, 'M월 d일 (E)', { locale: ko })
  const formattedYear = format(eventDate, 'yyyy년', { locale: ko })

  // Format time display
  const formatTimeDisplay = (time: string | null) => {
    if (!time) return null
    const [hours, minutes] = time.split(':').map(Number)
    const period = hours >= 12 ? 'PM' : 'AM'
    const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours
    return `${period} ${displayHours}:${String(minutes).padStart(2, '0')}`
  }

  return (
    <div className="bg-[var(--bg-secondary)] rounded-xl shadow-xl border border-[var(--border-default)] w-[320px] max-w-[90vw] overflow-hidden">
      {/* Header with color indicator */}
      <div className={`h-2 ${colorConfig.bg} ${colorConfig.border} border-b-4`} />

      {/* Content */}
      <div className="p-4">
        {/* Type Badge + Title */}
        <div className="flex items-start gap-3 mb-3">
          <div className={`w-3 h-3 rounded-full mt-1.5 flex-shrink-0 ${colorConfig.dot}`} />
          <div className="flex-1 min-w-0">
            {/* Type Badge Row */}
            <div className="flex items-center gap-1.5 flex-wrap mb-1">
              <span className={`text-[11px] px-1.5 py-0.5 rounded font-medium ${
                isPostponed ? 'bg-gray-200 text-gray-500' : `${colorConfig.bg} text-[var(--text-secondary)]`
              }`}>
                {getTypeLabel()}
              </span>
              {videoBadge && !isPostponed && (
                <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${videoBadge.color}`}>
                  {videoBadge.label}
                </span>
              )}
              {eventType === 'DEADLINE' && daysUntil !== undefined && (
                <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${
                  daysUntil <= 1 ? 'bg-red-100 text-red-700' :
                  daysUntil <= 3 ? 'bg-orange-100 text-orange-700' :
                  daysUntil <= 7 ? 'bg-yellow-100 text-yellow-700' :
                  'bg-green-100 text-green-700'
                }`}>
                  {formatDaysUntil(daysUntil)}
                </span>
              )}
            </div>

            {/* Title */}
            <h3 className={`text-base font-semibold leading-tight ${isPostponed ? 'text-[var(--text-muted)] line-through' : 'text-[var(--text-primary)]'}`}>
              {calendarEvent.title}
            </h3>

            {/* Case Name (if different from title) */}
            {caseName && caseName !== calendarEvent.title && (
              <p className="text-sm text-[var(--text-secondary)] mt-0.5 truncate">
                {caseName}
              </p>
            )}
          </div>
        </div>

        {/* Details Section */}
        <div className="space-y-2 text-sm">
          {/* Date & Time */}
          <div className="flex items-center gap-2 text-[var(--text-secondary)]">
            <svg className="w-4 h-4 flex-shrink-0 text-[var(--text-tertiary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>
              {formattedDate}
              {timeStr && <span className="ml-1 font-medium">{formatTimeDisplay(timeStr)}</span>}
              <span className="text-[var(--text-tertiary)] ml-1 text-xs">({formattedYear})</span>
            </span>
          </div>

          {/* Location */}
          {location && (
            <div className="flex items-start gap-2 text-[var(--text-secondary)]">
              <svg className="w-4 h-4 flex-shrink-0 text-[var(--text-tertiary)] mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span className="break-words">{location}</span>
            </div>
          )}

          {/* Case Number */}
          {caseNumber && (
            <div className="flex items-center gap-2 text-[var(--text-secondary)]">
              <svg className="w-4 h-4 flex-shrink-0 text-[var(--text-tertiary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <span className="font-mono text-xs">{caseNumber}</span>
            </div>
          )}

          {/* Attending Lawyer */}
          {attendingLawyerName && (
            <div className="flex items-center gap-2 text-[var(--text-secondary)]">
              <svg className="w-4 h-4 flex-shrink-0 text-[var(--text-tertiary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span>{attendingLawyerName} 변호사</span>
            </div>
          )}

          {/* Result (for court hearings) */}
          {scourtResultRaw && (
            <div className="flex items-center gap-2">
              <svg className="w-4 h-4 flex-shrink-0 text-[var(--sage-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span className="text-[var(--sage-primary)] font-medium">{scourtResultRaw}</span>
            </div>
          )}

          {/* Description */}
          {description && (
            <div className="pt-2 mt-2 border-t border-[var(--border-subtle)]">
              <p className="text-xs text-[var(--text-tertiary)] whitespace-pre-wrap line-clamp-3">
                {description}
              </p>
            </div>
          )}
        </div>

        {/* Action Buttons */}
        <div className="flex items-center gap-2 mt-4 pt-3 border-t border-[var(--border-subtle)]">
          {caseId && (
            <button
              onClick={handleCaseClick}
              className="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-xs font-medium text-white bg-[var(--sage-primary)] rounded-lg hover:bg-[var(--sage-primary-hover)] transition-colors"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
              사건 페이지
            </button>
          )}
          {!caseId && eventType === 'CONSULTATION' && (
            <button
              onClick={() => router.push('/admin/consultations')}
              className="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-xs font-medium text-white bg-[var(--color-info)] rounded-lg hover:opacity-90 transition-colors"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
              상담 관리
            </button>
          )}
        </div>
      </div>
    </div>
  )
}
